import numpy as np
import json
from PIL import Image
import base64
from io import BytesIO
import boto3

def normalize(x, axis):
    eps = np.finfo(float).eps
    mean = np.mean(x, axis=axis, keepdims=True)
    std = np.std(x, axis=axis, keepdims=True) + eps
    return (x - mean) / std

def convert_image_for_prediction(base64_encoded_image):
    image_contents = base64_encoded_image.split(",")
    image_in_bytes = base64.b64decode(image_contents[1])
    image = Image.open(BytesIO(image_in_bytes)).convert("L")
    image = image.resize((28,28))
    image_array = np.array(image)
    normalized_image = normalize([image_array], axis=(1, 2))
    image_formatted_for_prediction = np.expand_dims(normalized_image, 3).tolist()
    return json.dumps({"instances": image_formatted_for_prediction})

def generate_result(result):
    prediction_list = result["predictions"][0]
    prediction_list_sorted = sorted(prediction_list, reverse=True)
    first_guess = prediction_list.index(prediction_list_sorted[0])
    second_guess = prediction_list.index(prediction_list_sorted[1])
    return {"first_guess": first_guess, "second_guess": second_guess}

runtime = boto3.Session().client('sagemaker-runtime')
base64_encoded_image = "data:image/png;base64,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"
data = convert_image_for_prediction(base64_encoded_image)
response = runtime.invoke_endpoint(EndpointName="number-guess", ContentType='application/json', Body=data)
result = json.loads(response['Body'].read().decode())
print(generate_result(result))
